<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>AI 맞춤 정원치유 코스 · 미니</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"/>
<style>
  :root{ --ink:#0f172a; --muted:#64748b; --pri:#2563eb; --panel:#fff; --btn-h:44px; }
  *{box-sizing:border-box}
  html,body{
    margin:0;background:transparent;color:var(--ink);
    font-family:"Pretendard Variable","Pretendard","Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;
    letter-spacing:-0.3px;
  }

  .wrap{max-width:440px;margin:0 auto;padding:12px}
  .card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(2,6,23,.10);padding:14px}

  /* 헤더: 배지 + 타이틀(한 줄 고정) */
  .head{display:flex;align-items:center;gap:8px;min-width:0}
  .badge{font-size:11px;color:#fff;background:#2563eb;border-radius:999px;padding:3px 8px;white-space:nowrap;flex:0 0 auto}
  .title{margin:0;font-size:16px;letter-spacing:-0.4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1 1 auto}
  @media (max-width:640px){ .badge{font-size:10px;padding:2px 7px} .title{font-size:15px} }

  .muted{color:var(--muted);font-size:12px}
  label{display:flex;justify-content:space-between;align-items:center;font-size:13px;margin-top:6px;font-weight:700}
  .val{font-weight:900}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}

  .btn{background:var(--pri);color:#fff;border:0;border-radius:10px;padding:0 14px;height:var(--btn-h);
       display:flex;align-items:center;justify-content:center;font-weight:800;cursor:pointer}
  .ghost{background:#eef2ff;color:#2b46e3}
  .btn-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
  @media (max-width:420px){ .btn-grid{grid-template-columns:1fr} }

  .top3{margin-top:10px}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media (min-width:420px){ .grid{grid-template-columns:1fr 1fr} }
  .course{border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  .course h4{margin:0 0 4px 0;font-size:15px;letter-spacing:-0.4px}
  .pill{display:inline-block;font-size:11px;background:#eef2ff;border-radius:999px;padding:4px 8px;margin-right:6px;margin-top:4px}
  .gauge{height:6px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar{height:6px;background:linear-gradient(90deg,#22c55e,#16a34a);width:0;border-radius:999px}

  /* 패널 접힘 */
  .panel.collapsed{display:none}

  /* 내부 토글(프레임 안에서 항상 보임) */
  .toggle{
    position:fixed; right:14px; bottom:14px;   /* 접힘 때도 프레임 안에서 보이게 낮춤 */
    z-index:10001; background:#2563eb; color:#fff; border:0; border-radius:999px;
    padding:10px 16px; font-weight:900; cursor:pointer; box-shadow:0 8px 20px rgba(37,99,235,.35)
  }
  .toggle.off{opacity:.9;background:#3b82f6}
  /* 접힘 상태에선 토글 더 아래로 붙이기 (작은 프레임에서도 보이도록) */
  body.collapsed .toggle{ bottom:6px; right:6px; }

  /* 설문 모달 */
  .modal-root{position:fixed;inset:0;display:none;z-index:10002}
  .modal-root.open{display:block}
  .backdrop{position:absolute;inset:0;background:rgba(15,23,42,.45);backdrop-filter:saturate(120%) blur(2px)}
  .modal{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,480px);height:min(86vh,760px);
         background:#fff;border-radius:16px;box-shadow:0 20px 50px rgba(2,6,23,.35);display:flex;flex-direction:column;overflow:hidden}
  .modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eef2ff;font-weight:900}
  .modal-body{flex:1;background:#f8fafc}
  .modal-body iframe{width:100%;height:100%;border:0;background:#fff}
  .modal-foot{padding:10px 14px;border-top:1px solid #eef2ff;display:flex;gap:8px;justify-content:flex-end}
  .modal-head .title{font-size:14px} .modal-head .close{background:#eef2ff;color:#334155;border:0;border-radius:10px;padding:6px 10px;font-weight:800;cursor:pointer}
</style>
</head>
<body>

<button id="toggle" class="toggle" aria-pressed="true" title="보이기/숨기기 (T)">ON</button>

<div id="panel" class="panel">
  <div class="wrap"><div class="card">
    <div class="head">
      <span class="badge">2025 서울국제정원박람회</span>
      <h1 class="title">AI 맞춤 정원치유 코스</h1>
    </div>
    <div class="muted">기분·스트레스 지표 + 선호 태그 기반, 추천 3코스 바로 실행</div>

    <label>현재 기분(VAS) <span class="val" id="moodVal">5</span>/10</label>
    <input type="range" id="mood" min="0" max="10" value="5" style="width:100%">
    <label>현재 스트레스(VAS) <span class="val" id="stressVal">5</span>/10</label>
    <input type="range" id="stress" min="0" max="10" value="5" style="width:100%">

    <div class="row" style="margin-top:6px">
      <label style="font-weight:600;font-size:12px"><input type="checkbox" class="pref" value="조용함" checked> 조용함</label>
      <label style="font-weight:600;font-size:12px"><input type="checkbox" class="pref" value="그늘"> 그늘/시원함</label>
      <label style="font-weight:600;font-size:12px"><input type="checkbox" class="pref" value="저속 보행"> 저속 보행</label>
      <label style="font-weight:600;font-size:12px"><input type="checkbox" class="pref" value="자연 소리"> 자연 소리</label>
      <label style="font-weight:600;font-size:12px"><input type="checkbox" class="pref" value="앉아서 휴식"> 앉아서 휴식</label>
      <label style="font-weight:600;font-size:12px"><input type="checkbox" class="pref" value="햇살"> 햇살</label>
      <label style="font-weight:600;font-size:12px"><input type="checkbox" class="pref" value="수변"> 수변</label>
      <label style="font-weight:600;font-size:12px"><input type="checkbox" class="pref" value="전망"> 전망</label>
    </div>

    <div class="btn-grid">
      <button class="btn" id="recBtn">추천 3개 보기</button>
      <button class="btn ghost" id="allBtn">모든 코스 보기</button>
      <button class="btn ghost" id="surveyBtn">설문 참여</button>
      <button class="btn ghost" id="endBtn">종료/리포트</button>
    </div>

    <div id="status" class="muted" style="display:none;margin-top:6px"></div>

    <div id="top3" class="top3" style="display:none"><h3 style="margin:10px 0 6px 0;font-size:15px">추천 코스 Top 3</h3><div id="topGrid" class="grid"></div></div>
    <div id="all" style="display:none"><h3 style="margin:10px 0 6px 0;font-size:15px">전체 코스</h3><div id="allGrid" class="grid"></div></div>

    <form id="topForm" method="get" target="_top" style="display:none"></form>
  </div></div>
</div>

<!-- 설문 모달 -->
<div id="surveyRoot" class="modal-root" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="backdrop" id="surveyBackdrop"></div>
  <div class="modal" role="document">
    <div class="modal-head">
      <div class="title">치유 경험 설문</div>
      <button class="close" id="surveyClose" aria-label="닫기">닫기</button>
    </div>
    <div class="modal-body"><iframe id="surveyFrame" src="" loading="lazy" title="설문"></iframe></div>
    <div class="modal-foot"><button class="btn ghost" id="surveyOpenNew">새 창에서 열기</button></div>
  </div>
</div>

<script>
/* ===== 유틸 ===== */
const $=id=>document.getElementById(id);
const DL=[
 "https://my.mpskin.com/tour/38ca3651j?play=1&sr=,-.01&ss=217",
 "https://my.mpskin.com/tour/38ca3651j?play=1&sr=-3.12,.58&ss=226",
 "https://my.mpskin.com/tour/38ca3651j?play=1&sr=-3.09,-.06&ss=179",
 "https://my.mpskin.com/tour/38ca3651j?play=1&sr=3.13,1.53&ss=148",
 "https://my.mpskin.com/tour/38ca3651j?play=1&sr=-.03,-.67&ss=243",
 "https://my.mpskin.com/tour/38ca3651j?play=1&sr=-3.11,-1.03&ss=151",
 "https://my.mpskin.com/tour/38ca3651j?play=1&sr=.09,-.47&ss=240",
 "https://my.mpskin.com/tour/38ca3651j?play=1&sr=-.01,-.31&ss=123",
 "https://my.mpskin.com/tour/38ca3651j?play=1&sr=.03,-.14&ss=105",
 "https://my.mpskin.com/tour/38ca3651j?play=1&sr=-.01,.4&ss=163",
 "https://my.mpskin.com/tour/38ca3651j?play=1&sr=3.07,1.04&ss=45",
 "https://my.mpskin.com/tour/38ca3651j?play=1&sr=.04,1.31&ss=85"
];
const COURSES=[
 {title:"고요한 호흡 코스", dur:"10분", steps:"3곳", desc:"4-4-6 호흡, 조용·앉아서.", link:DL[0], tags:["조용함","앉아서 휴식"]},
 {title:"그늘 보행 코스", dur:"15분", steps:"4곳", desc:"그늘 위주 저속 보행.", link:DL[1], tags:["그늘","저속 보행"]},
 {title:"사운드 포인트", dur:"12분", steps:"3곳", desc:"바람·새·물소리 집중.", link:DL[2], tags:["자연 소리","조용함"]},
 {title:"숲 명상 코스", dur:"8분", steps:"3곳", desc:"호흡 관찰·신체 스캔.", link:DL[3], tags:["조용함","명상"]},
 {title:"햇살 스트레칭", dur:"7분", steps:"3곳", desc:"따뜻한 지점 스트레칭.", link:DL[4], tags:["햇살"]},
 {title:"솔바람 길", dur:"12분", steps:"3곳", desc:"솔향 가득한 산책.", link:DL[5], tags:["저속 보행","자연 소리"]},
 {title:"수변 휴식 포인트", dur:"10분", steps:"3곳", desc:"물가에서 호흡 휴식.", link:DL[6], tags:["수변","조용함"]},
 {title:"소나무 쉼터", dur:"9분", steps:"3곳", desc:"그늘+앉아 휴식.", link:DL[7], tags:["그늘","앉아서 휴식"]},
 {title:"야생화 산책", dur:"11분", steps:"3곳", desc:"가벼운 산책과 관찰.", link:DL[8], tags:["저속 보행","햇살"]},
 {title:"전망 포인트 호흡", dur:"8분", steps:"2곳", desc:"전망 지점에서 심호흡.", link:DL[9], tags:["전망","호흡"]},
 {title:"숲길 리듬 보행", dur:"10분", steps:"3곳", desc:"메트로놈 템포 보행.", link:DL[10], tags:["저속 보행","조용함"]},
 {title:"음영 명상 지대", dur:"9분", steps:"3곳", desc:"시원한 음영에서 명상.", link:DL[11], tags:["그늘","조용함"]}
];
const SURVEY_URL="https://naver.me/57QTs9oa";

/* ===== 값 표시 ===== */
function renderVals(){ $('moodVal').textContent=$('mood').value; $('stressVal').textContent=$('stress').value; }
$('mood').addEventListener('input',renderVals); $('stress').addEventListener('input',renderVals); renderVals();

/* ===== 추천 ===== */
const prefs=()=> new Set([...document.querySelectorAll('.pref:checked')].map(i=>i.value));
function score(course, ps, mood, stress){
  let s=0; course.tags.forEach(t=>{ if(ps.has(t)) s+=0.5; });
  if(stress>=7 && (course.tags.includes('조용함')||course.tags.includes('명상'))) s+=0.2;
  if(mood<=3 && (course.tags.includes('조용함')||course.tags.includes('명상'))) s+=0.1;
  return s;
}
function mkCourseCard(c, pct){
  const div=document.createElement('div'); div.className='course';
  div.innerHTML=`<h4>${c.title}</h4>
    <div class="gauge"><div class="bar" style="width:${pct||0}%"></div></div>
    <div class="muted">${c.desc}</div>
    <div style="margin:6px 0"><span class="pill">약 ${c.dur}</span><span class="pill">${c.steps}</span>${c.tags.map(t=>`<span class="pill">${t}</span>`).join(' ')}</div>
    <button class="btn" data-link="${c.link}">시작하기</button>`;
  div.querySelector('button').addEventListener('click', ()=> start(c.link));
  return div;
}
function recommendTop3(){
  const m=+$('mood').value, s=+$('stress').value, ps=prefs();
  const list=COURSES.map(c=>({c,v:score(c,ps,m,s)})).sort((a,b)=>b.v-a.v).slice(0,3);
  $('topGrid').innerHTML=''; list.forEach(({c,v})=> $('topGrid').appendChild(mkCourseCard(c,Math.round((v+0.6)*100))));
  $('top3').style.display='block'; $('all').style.display='none';
}
function showAll(){ $('allGrid').innerHTML=''; COURSES.forEach(c=> $('allGrid').appendChild(mkCourseCard(c,0))); $('all').style.display='block'; $('top3').style.display='none'; }
document.getElementById('recBtn').addEventListener('click', recommendTop3);
document.getElementById('allBtn').addEventListener('click', showAll);

/* ===== 메인 VR로 이동 ===== */
function toTop(url){
  try{ window.top.location.href=url; return; }catch(e){}
  try{ window.top.location.assign(url); return; }catch(e){}
  const u=new URL(url), f=$('topForm'); f.action=u.origin+u.pathname; f.innerHTML='';
  u.searchParams.forEach((v,k)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=k; i.value=v; f.appendChild(i); });
  f.submit();
}
let SESSION=null;
function uuid(){ return 's'+Math.random().toString(16).slice(2)+Date.now().toString(36); }
function start(baseUrl){
  if(!SESSION){ SESSION={ id:uuid(), baseline:{mood:+$('mood').value, stress:+$('stress').value}, startTs:Date.now() }; }
  const url=`${baseUrl}&session=${SESSION.id}&mood=${SESSION.baseline.mood}&stress=${SESSION.baseline.stress}`;
  toTop(url);
}

/* ===== 종료/리포트(샘플) ===== */
document.getElementById('endBtn').addEventListener('click', async()=>{
  if(!SESSION){ alert('먼저 코스를 시작하세요.'); return; }
  const final=prompt('체험 종료 스트레스(VAS) (0~10)', '4'); if(final===null) return;
  SESSION.endTs=Date.now(); SESSION.finalStress=Number(final);
  const msg=`리포트(샘플)\n세션:${SESSION.id}\n사전:${SESSION.baseline.stress} → 사후:${SESSION.finalStress}`;
  $('status').style.display='block'; $('status').textContent=msg;
});

/* ===== 설문 모달 ===== */
const surveyRoot=$('surveyRoot'), surveyFrame=$('surveyFrame');
$('surveyBtn').addEventListener('click', ()=>{ surveyRoot.classList.add('open'); surveyFrame.src=SURVEY_URL; });
$('surveyBackdrop').addEventListener('click', ()=>{ surveyRoot.classList.remove('open'); surveyFrame.removeAttribute('src'); });
$('surveyClose').addEventListener('click', ()=>{ surveyRoot.classList.remove('open'); surveyFrame.removeAttribute('src'); });
$('surveyOpenNew').addEventListener('click', ()=> window.open(SURVEY_URL,'_blank','noopener'));

/* ===== 내부 토글 + 부모에게 상태 알림 ===== */
const TOGGLE=$('toggle'), PANEL=$('panel');
function setOpen(open){
  PANEL.classList.toggle('collapsed', !open);
  document.body.classList.toggle('collapsed', !open);  // 접힘 상태일 때 토글 위치 보정용
  TOGGLE.textContent = open ? 'ON' : 'OFF';
  TOGGLE.classList.toggle('off', !open);
  TOGGLE.setAttribute('aria-pressed', String(open));
  try{ localStorage.setItem('mini_open', open?'1':'0'); }catch(e){}
  /* 부모(MP SKIN)에 알려서 프레임 크기를 동기화 */
  try{ window.parent.postMessage({ type:'garden-mini-open', open }, '*'); }catch(e){}
}
(function init(){
  let open=true; try{ const s=localStorage.getItem('mini_open'); if(s==='0') open=false; }catch(e){}
  setOpen(open);
  try{ window.parent.postMessage({ type:'garden-mini-ready', open }, '*'); }catch(e){}
})();
TOGGLE.addEventListener('click', ()=> setOpen(TOGGLE.textContent!=='ON'));
window.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='t') setOpen(TOGGLE.textContent!=='ON'); });
</script>
</body>
</html>
